<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#060a14">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>TrackGuard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
:root{--bg:#060a14;--surface:#0d1424;--surface2:#131d30;--accent:#00d4ff;--accent2:#ff4757;--accent3:#2ed573;--warn:#ffa502;--text:#e8f4f8;--text2:#7a9bb5;--border:rgba(0,212,255,0.15);--glow:rgba(0,212,255,0.3);}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation;}
html,body{width:100%;height:100%;font-family:'Rajdhani',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;position:fixed;}
#map{position:absolute;inset:0;z-index:1;background:#0d1424;}
.leaflet-tile-pane{filter:saturate(0.6) brightness(0.8);}

/* HUD TOP */
#hud-top{position:absolute;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:12px 16px 10px;padding-top:calc(env(safe-area-inset-top,0px)+12px);background:linear-gradient(to bottom,rgba(6,10,20,0.96) 70%,transparent);pointer-events:none;}
#hud-top>*{pointer-events:auto;}
.logo{font-size:20px;font-weight:700;letter-spacing:3px;color:var(--accent);text-shadow:0 0 20px var(--glow);text-transform:uppercase;}
.logo span{color:var(--accent2);}
#speed-box{text-align:center;line-height:1;}
#speed-val{font-family:'JetBrains Mono',monospace;font-size:30px;font-weight:600;color:var(--accent);text-shadow:0 0 12px var(--glow);display:block;}
#speed-unit{font-size:10px;color:var(--text2);letter-spacing:2px;text-transform:uppercase;}
#btn-history{width:44px;height:44px;border-radius:12px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;}

/* STATUS */
#status-bar{position:absolute;top:70px;left:50%;transform:translateX(-50%);z-index:102;background:rgba(13,20,36,0.9);border:1px solid var(--border);border-radius:20px;padding:5px 14px;font-size:12px;color:var(--text2);letter-spacing:1px;white-space:nowrap;transition:opacity .3s;max-width:90%;}
#status-bar.hidden{opacity:0;pointer-events:none;}

/* ALERT */
#alert-banner{position:absolute;top:74px;left:12px;right:12px;z-index:200;background:linear-gradient(135deg,rgba(255,71,87,0.97),rgba(180,30,45,0.97));border:1px solid var(--accent2);border-radius:16px;padding:12px 16px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 4px 30px rgba(255,71,87,0.5);transform:translateY(-200px);transition:transform .4s cubic-bezier(0.34,1.56,0.64,1);pointer-events:none;overflow:hidden;}
#alert-banner.show{transform:translateY(0);pointer-events:auto;}
#alert-icon{font-size:30px;flex-shrink:0;}
#alert-body{flex:1;}
#alert-title{font-size:16px;font-weight:700;letter-spacing:1px;}
#alert-sub{font-size:12px;color:rgba(255,255,255,0.75);margin-top:3px;}
#alert-progress{position:absolute;bottom:0;left:0;height:4px;background:rgba(255,255,255,0.7);width:100%;}

/* ADD HINT */
#add-hint{position:absolute;top:74px;left:50%;transform:translateX(-50%);z-index:150;background:rgba(255,165,2,0.95);color:#060a14;padding:8px 18px;border-radius:20px;font-size:13px;font-weight:700;white-space:nowrap;display:none;pointer-events:none;}
#add-hint.show{display:block;}

/* BADGES */
#sens-badge{position:absolute;bottom:145px;left:14px;z-index:100;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:11px;color:var(--text2);letter-spacing:1px;display:none;}
#sens-badge.show{display:block;}
#sens-txt{font-weight:700;}
#sens-badge.fwd #sens-txt{color:var(--accent3);}
#sens-badge.bwd #sens-txt{color:var(--accent2);}
#gps-info{position:absolute;bottom:145px;right:14px;z-index:100;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:11px;color:var(--text2);letter-spacing:1px;}
#gps-info span{color:var(--accent3);font-family:'JetBrains Mono',monospace;}

/* CALIB BANNER â€” visible pendant calibration */
#calib-banner{position:absolute;top:74px;left:12px;right:12px;z-index:180;background:linear-gradient(135deg,rgba(255,165,2,0.97),rgba(180,100,0,0.97));border:1px solid var(--warn);border-radius:16px;padding:14px 16px;display:none;align-items:center;gap:12px;box-shadow:0 4px 20px rgba(255,165,2,0.4);}
#calib-banner.show{display:flex;}
#calib-pts{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;color:white;flex-shrink:0;min-width:40px;text-align:center;}
#calib-txt{font-size:13px;font-weight:600;color:white;line-height:1.4;}
#btn-calib-stop{margin-left:auto;background:white;color:#060a14;border:none;border-radius:10px;padding:8px 14px;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;cursor:pointer;flex-shrink:0;}

/* HUD BOTTOM */
#hud-bottom{position:absolute;bottom:0;left:0;right:0;z-index:100;padding:10px 14px;padding-bottom:calc(env(safe-area-inset-bottom,0px)+14px);background:linear-gradient(to top,rgba(6,10,20,0.98) 75%,transparent);}
#stats-bar{display:flex;gap:8px;margin-bottom:10px;}
.stat-box{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:8px 6px;text-align:center;}
.stat-val{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:600;color:var(--accent);line-height:1;}
.stat-lbl{font-size:9px;color:var(--text2);letter-spacing:1.5px;margin-top:3px;text-transform:uppercase;}
#btn-row{display:flex;gap:8px;align-items:center;}
#btn-add-danger{width:54px;height:54px;border-radius:14px;flex-shrink:0;background:rgba(255,165,2,0.1);border:1px solid var(--warn);color:var(--warn);font-size:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
#btn-add-danger.active{background:var(--warn);color:var(--bg);}
#btn-record{flex:1;height:54px;border-radius:14px;background:rgba(46,213,115,0.1);border:1.5px solid var(--accent3);color:var(--accent3);font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .3s;}
#btn-record.recording{background:rgba(255,71,87,0.1);border-color:var(--accent2);color:var(--accent2);animation:pulse-rec 1.5s ease-in-out infinite;}
@keyframes pulse-rec{0%,100%{box-shadow:0 0 10px rgba(255,71,87,0.2);}50%{box-shadow:0 0 25px rgba(255,71,87,0.5);}}
#btn-center{width:54px;height:54px;border-radius:14px;flex-shrink:0;background:var(--surface);border:1px solid var(--border);color:var(--accent);font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.dmk{font-size:26px;line-height:1;cursor:pointer;filter:drop-shadow(0 0 5px rgba(255,165,2,0.7));}

/* MODALS */
.overlay{position:fixed;inset:0;z-index:500;background:rgba(6,10,20,0.88);backdrop-filter:blur(6px);display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.overlay.show{opacity:1;pointer-events:auto;}
.sheet{background:var(--surface);border:1px solid var(--border);border-radius:22px 22px 0 0;padding:16px 18px 24px;width:100%;max-width:520px;max-height:88vh;overflow-y:auto;transform:translateY(100%);transition:transform .35s cubic-bezier(0.34,1.56,0.64,1);padding-bottom:calc(env(safe-area-inset-bottom,0px)+24px);}
.overlay.show .sheet{transform:translateY(0);}
.sheet-handle{width:42px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.sheet-title{font-size:17px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:16px;}
label{display:block;font-size:11px;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;}
input,select,textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:15px;padding:10px 12px;outline:none;margin-bottom:12px;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
select option{background:var(--surface2);}
textarea{resize:none;height:64px;}
.btn{width:100%;padding:14px;border:none;border-radius:12px;cursor:pointer;font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-top:4px;}
.btn-primary{background:linear-gradient(135deg,var(--accent),#0099cc);color:var(--bg);}
.btn-warn{background:linear-gradient(135deg,var(--warn),#cc8000);color:var(--bg);}
.btn-ghost{background:var(--surface2);border:1px solid var(--border);color:var(--text2);}
.tabs{display:flex;gap:6px;margin-bottom:14px;}
.tab{flex:1;padding:9px;text-align:center;border-radius:8px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;}
.tab.active{background:rgba(0,212,255,0.1);border-color:var(--accent);color:var(--accent);}
.card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px 14px;margin-bottom:8px;}
.card-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.card-date{font-size:12px;color:var(--text2);}
.card-stats{display:flex;gap:14px;margin-top:6px;flex-wrap:wrap;}
.cstat{font-size:12px;color:var(--text2);}
.cstat strong{color:var(--accent);font-family:'JetBrains Mono',monospace;}
.btn-icon{background:none;border:none;font-size:18px;cursor:pointer;padding:2px 6px;}
.danger-row{background:var(--surface2);border:1px solid rgba(255,165,2,0.2);border-radius:10px;padding:10px 12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;}
.di{font-size:22px;flex-shrink:0;}.dn{flex:1;}
.dn-title{font-size:14px;font-weight:600;color:var(--warn);}
.dn-coord{font-size:10px;color:var(--text2);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.dn-actions{display:flex;gap:6px;}
.dna{background:var(--surface);border:1px solid var(--border);color:var(--text2);padding:5px 9px;border-radius:7px;cursor:pointer;font-size:13px;}
.recap-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.recap-box{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center;}
.recap-val{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:600;color:var(--accent);}
.recap-lbl{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1.5px;margin-top:4px;}
.empty{text-align:center;padding:30px;color:var(--text2);}
.empty-icon{font-size:36px;margin-bottom:8px;}

/* CALIB MODAL */
.calib-steps{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;}
.calib-step{display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);}
.step-num{width:28px;height:28px;border-radius:50%;background:var(--accent);color:var(--bg);font-weight:700;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.step-txt{font-size:13px;color:var(--text2);line-height:1.5;}
.step-txt strong{color:var(--text);}
.calib-result{background:rgba(46,213,115,0.1);border:1px solid var(--accent3);border-radius:10px;padding:12px;margin-bottom:12px;text-align:center;display:none;}
.calib-result.show{display:block;}
.calib-result .cr-val{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;color:var(--accent3);}
.calib-result .cr-lbl{font-size:12px;color:var(--text2);margin-top:4px;}

/* Popup */
.leaflet-popup-content-wrapper{background:var(--surface)!important;border:1px solid var(--border)!important;border-radius:12px!important;color:var(--text)!important;font-family:'Rajdhani',sans-serif!important;box-shadow:0 4px 20px rgba(0,0,0,0.5)!important;}
.leaflet-popup-tip-container{display:none;}
.leaflet-popup-content{margin:12px 14px!important;}
.pu-title{font-size:15px;font-weight:700;color:var(--warn);margin-bottom:4px;}
.pu-desc{font-size:12px;color:var(--text2);margin-bottom:4px;}
.pu-radius{font-size:11px;color:var(--text2);margin-bottom:10px;}
.pu-actions{display:flex;gap:8px;}
.pu-btn{padding:5px 12px;border-radius:8px;cursor:pointer;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;border:1px solid;background:transparent;}
.pu-edit{border-color:var(--accent);color:var(--accent);}
.pu-del{border-color:var(--accent2);color:var(--accent2);}
</style>
</head>
<body>

<div id="map"></div>

<div id="hud-top">
  <div class="logo">Track<span>Guard</span></div>
  <div id="speed-box"><span id="speed-val">0</span><span id="speed-unit">km/h</span></div>
  <button id="btn-history">ğŸ“‹</button>
</div>

<div id="status-bar">ğŸ“¡ Recherche GPS...</div>

<!-- Alerte danger -->
<div id="alert-banner">
  <div id="alert-icon">âš ï¸</div>
  <div id="alert-body"><div id="alert-title">Danger</div><div id="alert-sub">Vous approchez</div></div>
  <div id="alert-progress"></div>
</div>

<!-- Bandeau calibration actif -->
<div id="calib-banner">
  <div id="calib-pts">0</div>
  <div id="calib-txt">Avancez en <strong>marche avant</strong> sur au moins 10mâ€¦</div>
  <button id="btn-calib-stop">âœ“ TERMINER</button>
</div>

<div id="add-hint">ğŸ‘† Touchez la carte pour placer le danger</div>
<div id="gps-info">GPS Â±<span id="acc-val">--</span>m</div>
<div id="sens-badge">Sens : <span id="sens-txt">--</span></div>

<div id="hud-bottom">
  <div id="stats-bar">
    <div class="stat-box"><div class="stat-val" id="stat-dist">0.00</div><div class="stat-lbl">km</div></div>
    <div class="stat-box"><div class="stat-val" id="stat-time">00:00</div><div class="stat-lbl">Temps</div></div>
    <div class="stat-box"><div class="stat-val" id="stat-ndanger">0</div><div class="stat-lbl">Dangers</div></div>
  </div>
  <div id="btn-row">
    <button id="btn-add-danger">âš ï¸</button>
    <button id="btn-record">â–¶ DÃ‰MARRER</button>
    <button id="btn-center">â—</button>
  </div>
</div>

<!-- MODAL DANGER -->
<div class="overlay" id="ov-danger">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="danger-title">âš ï¸ Nouveau danger</div>
    <label>Type</label>
    <select id="d-type">
      <option value="âš ï¸">âš ï¸ Danger gÃ©nÃ©ral</option>
      <option value="ğŸš§">ğŸš§ Travaux</option>
      <option value="ğŸš—">ğŸš— Accident</option>
      <option value="ğŸ‘®">ğŸ‘® ContrÃ´le police</option>
      <option value="ğŸ¦Œ">ğŸ¦Œ Animaux traversant</option>
      <option value="ğŸŒŠ">ğŸŒŠ Inondation</option>
      <option value="ğŸ”¥">ğŸ”¥ Feu / FumÃ©e</option>
      <option value="ğŸ•³ï¸">ğŸ•³ï¸ Nid de poule</option>
      <option value="â„ï¸">â„ï¸ Verglas</option>
      <option value="ğŸš‘">ğŸš‘ Intervention urgence</option>
    </select>
    <label>Titre *</label>
    <input type="text" id="d-title-in" placeholder="Ex: Zone de chargement" maxlength="50">
    <label>Description (optionnel)</label>
    <textarea id="d-desc-in" placeholder="DÃ©tails..."></textarea>
    <label>Rayon d'alerte (mÃ¨tres)</label>
    <input type="number" id="d-radius-in" value="25" min="5" max="1000">
    <button class="btn btn-primary" id="btn-save-d">ğŸ’¾ ENREGISTRER</button>
    <button class="btn btn-ghost" id="btn-cancel-d">ANNULER</button>
  </div>
</div>

<!-- MODAL CALIBRATION -->
<div class="overlay" id="ov-calib">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">ğŸ§­ Calibration du sens de marche</div>

    <div class="calib-steps">
      <div class="calib-step">
        <div class="step-num">1</div>
        <div class="step-txt">Placez-vous au <strong>point de dÃ©part A</strong>, engin Ã  l'arrÃªt, prÃªt Ã  avancer.</div>
      </div>
      <div class="calib-step">
        <div class="step-num">2</div>
        <div class="step-txt">Appuyez sur <strong>"Lancer la calibration"</strong> ci-dessous.</div>
      </div>
      <div class="calib-step">
        <div class="step-num">3</div>
        <div class="step-txt">Avancez en <strong>marche avant</strong> jusqu'au point B (minimum <strong>10 mÃ¨tres</strong>).</div>
      </div>
      <div class="calib-step">
        <div class="step-num">4</div>
        <div class="step-txt">Appuyez sur <strong>"Terminer"</strong> dans le bandeau orange. L'app calcule automatiquement votre sens de marche.</div>
      </div>
    </div>

    <!-- RÃ©sultat si dÃ©jÃ  calibrÃ© -->
    <div class="calib-result" id="calib-result">
      <div class="cr-val" id="calib-deg">--Â°</div>
      <div class="cr-lbl">Cap marche avant enregistrÃ© â€” <span id="calib-cardinal">--</span></div>
    </div>

    <button class="btn btn-warn" id="btn-start-calib">ğŸš› LANCER LA CALIBRATION</button>
    <button class="btn btn-ghost" id="btn-close-calib" style="margin-top:8px">FERMER</button>
  </div>
</div>

<!-- MODAL PRÃ‰-DÃ‰MARRAGE -->
<div class="overlay" id="ov-prestart">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">â–¶ DÃ©marrer l'enregistrement</div>
    <div id="prestart-calib-ok" style="display:none">
      <div style="background:rgba(46,213,115,0.1);border:1px solid var(--accent3);border-radius:10px;padding:12px;margin-bottom:14px;text-align:center;">
        <div style="font-size:22px;margin-bottom:4px;">âœ…</div>
        <div style="font-size:14px;font-weight:600;color:var(--accent3);">Sens de marche calibrÃ©</div>
        <div style="font-size:12px;color:var(--text2);margin-top:4px;">Cap avant : <span id="ps-deg" style="color:var(--accent);font-family:'JetBrains Mono',monospace;">--Â°</span> (<span id="ps-card">--</span>)</div>
      </div>
    </div>
    <div id="prestart-calib-none" style="display:none">
      <div style="background:rgba(255,165,2,0.1);border:1px solid var(--warn);border-radius:10px;padding:12px;margin-bottom:14px;">
        <div style="font-size:13px;color:var(--warn);font-weight:600;">âš ï¸ Sens de marche non calibrÃ©</div>
        <div style="font-size:12px;color:var(--text2);margin-top:4px;line-height:1.5;">Toute distance sera comptÃ©e sans distinction avant/arriÃ¨re. Calibrez d'abord pour une mesure prÃ©cise.</div>
      </div>
    </div>
    <button class="btn btn-primary" id="btn-ps-go">â–¶ DÃ‰MARRER</button>
    <button class="btn btn-warn" id="btn-ps-calib" style="margin-top:8px">ğŸ§­ CALIBRER D'ABORD</button>
    <button class="btn btn-ghost" id="btn-ps-cancel" style="margin-top:8px">ANNULER</button>
  </div>
</div>

<!-- MODAL HISTORY -->
<div class="overlay" id="ov-history">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">ğŸ“‹ Mes donnÃ©es</div>
    <div class="tabs">
      <div class="tab active" data-tab="sessions">Historique</div>
      <div class="tab" data-tab="dangers">Dangers</div>
    </div>
    <div id="tab-sessions"></div>
    <div id="tab-dangers-list" style="display:none"></div>
    <button class="btn btn-ghost" id="btn-close-hist" style="margin-top:8px">FERMER</button>
  </div>
</div>

<!-- MODAL RECAP -->
<div class="overlay" id="ov-recap">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">ğŸ RÃ©cap session</div>
    <div class="recap-grid">
      <div class="recap-box"><div class="recap-val" id="rc-dist">--</div><div class="recap-lbl">Distance</div></div>
      <div class="recap-box"><div class="recap-val" id="rc-time">--</div><div class="recap-lbl">DurÃ©e</div></div>
      <div class="recap-box"><div class="recap-val" id="rc-spd">--</div><div class="recap-lbl">Vitesse moy.</div></div>
      <div class="recap-box"><div class="recap-val" id="rc-dng">--</div><div class="recap-lbl">Dangers croisÃ©s</div></div>
    </div>
    <button class="btn btn-primary" id="btn-close-recap">âœ“ OK</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let map, userMarker=null, userPos=null, userHeading=0;
let dangers=[], sessions=[];
let dangerMarkers={};
let addMode=false, editId=null, pendingPos=null;
let recording=false, recTimer=null, elapsedSec=0, totalDist=0;
let lastPos=null, alerted=new Set(), alertTimeout=null;
let audioCtx=null, sessionDangersCrossed=0;
let trackPolyline=null, trackPoints=[];
let forwardDir=null;  // cap "marche avant" en degrÃ©s, null = non calibrÃ©

// Calibration Aâ†’B
let calibrating=false;
let calibPoints=[];   // positions collectÃ©es pendant la calibration

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTRE DE KALMAN SIMPLIFIÃ‰ (GPS smoothing)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RÃ©duit le bruit GPS : fusionne mesures brutes avec Ã©tat prÃ©dit
// selon la prÃ©cision dÃ©clarÃ©e par le capteur
const kalman = {
  lat: null, lng: null,
  accuracy: null,
  timestamp: null,

  reset() { this.lat=null; this.lng=null; this.accuracy=null; this.timestamp=null; },

  update(lat, lng, acc, ts) {
    // Premier fix : initialiser directement
    if (this.lat === null) {
      this.lat=lat; this.lng=lng; this.accuracy=acc; this.timestamp=ts;
      return {lat, lng, acc};
    }

    const dt = Math.max((ts - this.timestamp) / 1000, 0.1); // secondes
    // Variance de processus : on suppose le vÃ©hicule peut bouger jusqu'Ã  3 m/sÂ²
    const Q = 3 * dt;
    // Variance de mesure = prÃ©cision dÃ©clarÃ©e
    const R = Math.max(acc, 2);

    // Gain de Kalman : plus la prÃ©cision est bonne (R petit), plus on fait confiance Ã  la mesure
    const K = this.accuracy / (this.accuracy + R + Q);

    this.lat   = this.lat   + K * (lat - this.lat);
    this.lng   = this.lng   + K * (lng - this.lng);
    this.accuracy = (1 - K) * (this.accuracy + Q);
    this.timestamp = ts;

    return { lat: this.lat, lng: this.lng, acc: this.accuracy };
  }
};

// Lissage du cap (moyenne glissante circulaire sur 5 valeurs)
const headingBuffer = [];
function smoothHeading(h) {
  headingBuffer.push(h);
  if (headingBuffer.length > 5) headingBuffer.shift();
  // Moyenne circulaire
  let sinSum=0, cosSum=0;
  headingBuffer.forEach(a => { sinSum+=Math.sin(a*Math.PI/180); cosSum+=Math.cos(a*Math.PI/180); });
  return (Math.atan2(sinSum/headingBuffer.length, cosSum/headingBuffer.length)*180/Math.PI+360)%360;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function save(){
  try{
    localStorage.setItem('tg4_dangers',JSON.stringify(dangers));
    localStorage.setItem('tg4_sessions',JSON.stringify(sessions));
    if(forwardDir!==null) localStorage.setItem('tg4_fwd',String(forwardDir));
  }catch(e){}
}
function load(){
  try{dangers=JSON.parse(localStorage.getItem('tg4_dangers')||'[]');}catch(e){dangers=[];}
  try{sessions=JSON.parse(localStorage.getItem('tg4_sessions')||'[]');}catch(e){sessions=[];}
  const fwd=localStorage.getItem('tg4_fwd');
  if(fwd!==null) forwardDir=parseFloat(fwd);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap(){
  if(typeof L==='undefined'){setStatus('âŒ Carte non chargÃ©e');return;}
  map=L.map('map',{zoomControl:false,attributionControl:true,tap:true,tapTolerance:15,center:[46.2276,2.2137],zoom:6});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map);
  map.on('click',e=>{if(!addMode)return;pendingPos=[e.latlng.lat,e.latlng.lng];editId=null;openDangerModal(false);});
  startGPS();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARQUEUR FLÃˆCHE SVG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeArrowIcon(deg){
  const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 44 44">
    <defs><filter id="gw" x="-60%" y="-60%" width="220%" height="220%">
      <feGaussianBlur stdDeviation="2.5" result="b"/>
      <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter></defs>
    <circle cx="22" cy="26" r="13" fill="rgba(0,212,255,0.15)"/>
    <circle cx="22" cy="26" r="10" fill="#00d4ff" filter="url(#gw)"/>
    <circle cx="22" cy="26" r="10" fill="none" stroke="white" stroke-width="2.5"/>
    <polygon points="22,3 15,20 29,20" fill="#00d4ff" filter="url(#gw)"/>
    <polygon points="22,3 15,20 29,20" fill="none" stroke="white" stroke-width="2" stroke-linejoin="round"/>
    <circle cx="22" cy="26" r="3.5" fill="white"/>
  </svg>`;
  return L.divIcon({
    html:`<div style="width:44px;height:44px;transform:rotate(${deg}deg);transform-origin:50% 59%;">${svg}</div>`,
    iconSize:[44,44],iconAnchor:[22,26],className:''
  });
}
function updateUserMarker(pos,hdg){
  if(!userMarker){userMarker=L.marker(pos,{icon:makeArrowIcon(hdg),zIndexOffset:1000}).addTo(map);}
  else{userMarker.setLatLng(pos);userMarker.setIcon(makeArrowIcon(hdg));}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS avec filtre Kalman
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let firstFix=true, prevPos=null;
// Seuils de filtrage
const MIN_ACCURACY = 20;   // ignorer si prÃ©cision > 20m
const MIN_SPEED_MS = 0.5;  // ignorer mouvement si vitesse < 0.5 m/s (~1.8 km/h)
const MIN_DIST_M   = 1.5;  // ignorer dÃ©placement < 1.5m entre fixes

function startGPS(){
  if(!navigator.geolocation){setStatus('âŒ GPS non disponible');return;}
  navigator.geolocation.watchPosition(onGPS,onGPSErr,{enableHighAccuracy:true,timeout:15000,maximumAge:1000});
}

function onGPS(raw){
  const acc = raw.coords.accuracy;
  const ts  = raw.timestamp;

  // â”€â”€ Filtre 1 : ignorer les fixes trop imprÃ©cis
  if(acc > MIN_ACCURACY){
    document.getElementById('acc-val').textContent = 'âš ï¸'+Math.round(acc);
    return; // on garde la derniÃ¨re position connue
  }

  // â”€â”€ Filtre Kalman
  const k = kalman.update(raw.coords.latitude, raw.coords.longitude, acc, ts);
  const lat=k.lat, lng=k.lng;
  document.getElementById('acc-val').textContent = Math.round(k.acc);

  // â”€â”€ Filtre 2 : ignorer si quasi-immobile selon vitesse GPS
  const spd = raw.coords.speed; // m/s, null si inconnu
  const kmh = spd!=null&&spd>MIN_SPEED_MS ? Math.round(spd*3.6) : 0;
  document.getElementById('speed-val').textContent = kmh;

  // â”€â”€ Filtre 3 : ignorer si dÃ©placement < seuil (Ã©vite drift Ã  l'arrÃªt)
  const newPos=[lat,lng];
  const moved = prevPos ? distM(prevPos,newPos) : 999;
  const reallyMoved = moved >= MIN_DIST_M && (spd==null || spd >= MIN_SPEED_MS);

  if(reallyMoved){
    // Cap : lissÃ© par moyenne glissante
    let rawHdg = raw.coords.heading;
    if(rawHdg!=null&&!isNaN(rawHdg)&&spd>MIN_SPEED_MS){
      userHeading = smoothHeading(rawHdg);
    } else if(prevPos){
      userHeading = smoothHeading(bearing(prevPos,newPos));
    }
  }
  // Mettre Ã  jour position seulement si on s'est vraiment dÃ©placÃ©
  if(reallyMoved || !userPos){
    userPos = newPos;
    updateUserMarker(userPos, userHeading);
  }

  if(firstFix){firstFix=false;map.setView(userPos,16);setStatus('âœ… GPS actif',true);}

  // â”€â”€ Calibration Aâ†’B en cours
  if(calibrating && reallyMoved){
    calibPoints.push([...userPos]);
    document.getElementById('calib-pts').textContent = calibPoints.length;
    const totalCalibDist = calibPoints.length>1 ? distM(calibPoints[0],calibPoints[calibPoints.length-1]) : 0;
    const enough = totalCalibDist >= 10;
    document.getElementById('calib-txt').innerHTML = enough
      ? `<strong>${Math.round(totalCalibDist)}m</strong> parcourus âœ… â€” Appuyez sur Terminer`
      : `Avancez en <strong>marche avant</strong>â€¦ ${Math.round(totalCalibDist)}m / 10m min`;
  }

  // â”€â”€ Enregistrement
  if(recording && lastPos && reallyMoved){
    const d = distM(lastPos, userPos);
    if(d>0 && d<200){
      const moveBear = bearing(lastPos, userPos);
      if(isForward(moveBear)){
        totalDist += d/1000;
        document.getElementById('stat-dist').textContent=totalDist.toFixed(2);
        trackPoints.push([...userPos]);
        updateTrack();
        setSensBadge(true);
      } else {
        setSensBadge(false);
      }
    }
  }
  if(recording) lastPos=[...userPos];
  if(reallyMoved) prevPos=[...userPos];

  checkAlerts();
}

function onGPSErr(e){
  const m={1:'ğŸš« GPS refusÃ© â€” activez dans Chrome > ParamÃ¨tres du site',2:'ğŸ“¡ Signal GPS absent',3:'â±ï¸ Timeout GPS'};
  setStatus(m[e.code]||'âŒ Erreur GPS');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GÃ‰OMÃ‰TRIE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function haversine(a,b){
  const R=6371,dLat=(b[0]-a[0])*Math.PI/180,dLon=(b[1]-a[1])*Math.PI/180;
  const s=Math.sin(dLat/2)**2+Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
}
function distM(a,b){return haversine(a,b)*1000;}
function bearing(a,b){
  const la=a[0]*Math.PI/180,lb=b[0]*Math.PI/180,dl=(b[1]-a[1])*Math.PI/180;
  const y=Math.sin(dl)*Math.cos(lb),x=Math.cos(la)*Math.sin(lb)-Math.sin(la)*Math.cos(lb)*Math.cos(dl);
  return(Math.atan2(y,x)*180/Math.PI+360)%360;
}
function angleDiff(a,b){let d=Math.abs(a-b)%360;return d>180?360-d:d;}
function isForward(moveBear){
  if(forwardDir===null)return true;
  return angleDiff(moveBear,forwardDir)<=90;
}
function degToCardinal(d){
  const dirs=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'];
  return dirs[Math.round(d/22.5)%16];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALIBRATION Aâ†’B
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCalibModal(){
  // Afficher rÃ©sultat si dÃ©jÃ  calibrÃ©
  if(forwardDir!==null){
    document.getElementById('calib-result').classList.add('show');
    document.getElementById('calib-deg').textContent = Math.round(forwardDir)+'Â°';
    document.getElementById('calib-cardinal').textContent = degToCardinal(forwardDir);
  } else {
    document.getElementById('calib-result').classList.remove('show');
  }
  document.getElementById('ov-calib').classList.add('show');
}

tap('btn-start-calib',()=>{
  if(!userPos){setStatus('ğŸ“¡ GPS non disponible, attendez...');return;}
  // Fermer la modal et lancer la calibration
  document.getElementById('ov-calib').classList.remove('show');
  calibrating=true;
  calibPoints=[[...userPos]];
  document.getElementById('calib-pts').textContent='1';
  document.getElementById('calib-txt').innerHTML='Avancez en <strong>marche avant</strong>â€¦ 0m / 10m min';
  document.getElementById('calib-banner').classList.add('show');
  setStatus('ğŸ§­ Calibration en cours â€” avancez en marche avant',false);
});

tap('btn-calib-stop',()=>{
  if(!calibrating)return;
  // Besoin d'au moins 2 points sÃ©parÃ©s de 10m
  const totalDist = calibPoints.length>1 ? distM(calibPoints[0],calibPoints[calibPoints.length-1]) : 0;
  if(totalDist < 8){
    alert(`Distance insuffisante : ${Math.round(totalDist)}m parcourus.\nAvancez au moins 10m pour une calibration fiable.`);
    return;
  }
  finishCalib();
});

function finishCalib(){
  calibrating=false;
  document.getElementById('calib-banner').classList.remove('show');

  // Calcul du cap moyen sur tous les segments enregistrÃ©s
  // Utilise moyenne circulaire des bearings successifs
  let sinSum=0, cosSum=0, count=0;
  for(let i=1;i<calibPoints.length;i++){
    const b=bearing(calibPoints[i-1],calibPoints[i]);
    const d=distM(calibPoints[i-1],calibPoints[i]);
    if(d>0.3){
      // PondÃ©rer par la distance : les plus longs segments comptent plus
      sinSum+=Math.sin(b*Math.PI/180)*d;
      cosSum+=Math.cos(b*Math.PI/180)*d;
      count++;
    }
  }
  if(count===0){setStatus('âŒ Pas assez de mouvement dÃ©tectÃ©');return;}

  forwardDir=(Math.atan2(sinSum,cosSum)*180/Math.PI+360)%360;
  save();

  const card=degToCardinal(forwardDir);
  setStatus(`âœ… Sens calibrÃ© : ${Math.round(forwardDir)}Â° (${card})`,true);

  // Petit bip de confirmation
  beep();

  // Rouvrir la modal pour montrer le rÃ©sultat
  document.getElementById('calib-result').classList.add('show');
  document.getElementById('calib-deg').textContent=Math.round(forwardDir)+'Â°';
  document.getElementById('calib-cardinal').textContent=card;
  document.getElementById('ov-calib').classList.add('show');
}

tap('btn-close-calib',()=>document.getElementById('ov-calib').classList.remove('show'));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRÃ‰-DÃ‰MARRAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPrestart(){
  if(!userPos){setStatus('ğŸ“¡ GPS non disponible, attendez...');return;}
  // Afficher Ã©tat calibration
  if(forwardDir!==null){
    document.getElementById('prestart-calib-ok').style.display='block';
    document.getElementById('prestart-calib-none').style.display='none';
    document.getElementById('ps-deg').textContent=Math.round(forwardDir)+'Â°';
    document.getElementById('ps-card').textContent=degToCardinal(forwardDir);
  } else {
    document.getElementById('prestart-calib-ok').style.display='none';
    document.getElementById('prestart-calib-none').style.display='block';
  }
  document.getElementById('ov-prestart').classList.add('show');
}

tap('btn-ps-go',()=>{
  document.getElementById('ov-prestart').classList.remove('show');
  startRec();
});
tap('btn-ps-calib',()=>{
  document.getElementById('ov-prestart').classList.remove('show');
  openCalibModal();
});
tap('btn-ps-cancel',()=>document.getElementById('ov-prestart').classList.remove('show'));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SENS BADGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSensBadge(fwd){
  const el=document.getElementById('sens-badge');
  const txt=document.getElementById('sens-txt');
  el.classList.add('show');
  if(fwd){el.className='show fwd';txt.textContent='â–² EN AVANT';}
  else{el.className='show bwd';txt.textContent='â–¼ ARRIÃˆRE (ignorÃ©)';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRACÃ‰ TRAJECTOIRE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateTrack(){
  if(!map||trackPoints.length<2)return;
  if(trackPolyline){trackPolyline.setLatLngs(trackPoints);}
  else{
    trackPolyline=L.polyline(trackPoints,{color:'#00d4ff',weight:5,opacity:0.8,lineJoin:'round',lineCap:'round'}).addTo(map);
    L.circleMarker(trackPoints[0],{radius:6,color:'#2ed573',fillColor:'#2ed573',fillOpacity:1,weight:2}).addTo(map);
  }
}
function clearTrack(){if(trackPolyline){map.removeLayer(trackPolyline);trackPolyline=null;}trackPoints=[];}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ALERT_MS=10000;
function checkAlerts(){
  if(!userPos)return;
  for(const d of dangers){
    const dist=distM(userPos,[d.lat,d.lng]),r=d.radius||25;
    if(dist<=r&&!alerted.has(d.id)){alerted.add(d.id);sessionDangersCrossed++;triggerAlert(d,Math.round(dist));}
    if(dist>r*2.5)alerted.delete(d.id);
  }
}
function triggerAlert(d,dist){
  clearTimeout(alertTimeout);
  document.getElementById('alert-icon').textContent=d.type;
  document.getElementById('alert-title').textContent=d.title;
  document.getElementById('alert-sub').textContent=(d.desc||'Soyez prudent')+` Â· Ã  ${dist}m`;
  document.getElementById('alert-banner').classList.add('show');
  const bar=document.getElementById('alert-progress');
  bar.style.transition='none';bar.style.width='100%';
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    bar.style.transition=`width ${ALERT_MS}ms linear`;bar.style.width='0%';
  }));
  beep();
  alertTimeout=setTimeout(()=>document.getElementById('alert-banner').classList.remove('show'),ALERT_MS);
}
function beep(){
  try{
    if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    const ctx=audioCtx;
    [[880,0,0.13],[1200,0.2,0.13],[880,0.4,0.22]].forEach(([f,t,d])=>{
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.connect(g);g.connect(ctx.destination);
      o.type='sine';o.frequency.value=f;
      g.gain.setValueAtTime(0.4,ctx.currentTime+t);
      g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+d);
      o.start(ctx.currentTime+t);o.stop(ctx.currentTime+t+d+0.05);
    });
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOUTONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tap(id,fn){const el=document.getElementById(id);if(el)el.addEventListener('click',e=>{e.preventDefault();fn(e);});}
function unlockAudio(){if(!audioCtx){try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}}}

tap('btn-add-danger',()=>{
  unlockAudio();addMode=!addMode;
  document.getElementById('btn-add-danger').classList.toggle('active',addMode);
  document.getElementById('add-hint').classList.toggle('show',addMode);
  if(map)map.getContainer().style.cursor=addMode?'crosshair':'';
});
tap('btn-record',()=>{unlockAudio();if(recording)stopRecord();else openPrestart();});
tap('btn-center',()=>{if(userPos&&map)map.setView(userPos,17);else setStatus('ğŸ“¡ GPS pas encore disponible...');});
tap('btn-history',openHistory);
tap('btn-save-d',saveDanger);
tap('btn-cancel-d',closeDangerModal);
tap('btn-close-hist',()=>document.getElementById('ov-history').classList.remove('show'));
tap('btn-close-recap',()=>document.getElementById('ov-recap').classList.remove('show'));
document.getElementById('alert-banner').addEventListener('click',()=>{clearTimeout(alertTimeout);document.getElementById('alert-banner').classList.remove('show');});
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');
  const tab=t.dataset.tab;
  document.getElementById('tab-sessions').style.display=tab==='sessions'?'block':'none';
  document.getElementById('tab-dangers-list').style.display=tab==='dangers'?'block':'none';
}));

// AccÃ¨s Ã  la calibration depuis le bouton historique (long press) â€” via le menu history
// On ajoute un bouton calibration dans le HUD via le bouton center (long press)
// ou plus simple : ouvrir la calibration depuis le modal prestart

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENREGISTREMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startRec(){
  recording=true;elapsedSec=0;totalDist=0;
  lastPos=[...userPos];alerted.clear();sessionDangersCrossed=0;
  clearTrack();trackPoints.push([...userPos]);
  document.getElementById('btn-record').textContent='â¹ ARRÃŠTER';
  document.getElementById('btn-record').classList.add('recording');
  document.getElementById('stat-dist').textContent='0.00';
  document.getElementById('stat-time').textContent='00:00';
  document.getElementById('sens-badge').classList.add('show');
  recTimer=setInterval(()=>{
    elapsedSec++;
    document.getElementById('stat-time').textContent=
      `${String(Math.floor(elapsedSec/60)).padStart(2,'0')}:${String(elapsedSec%60).padStart(2,'0')}`;
  },1000);
}
function stopRecord(){
  recording=false;clearInterval(recTimer);
  document.getElementById('btn-record').textContent='â–¶ DÃ‰MARRER';
  document.getElementById('btn-record').classList.remove('recording');
  document.getElementById('sens-badge').classList.remove('show');
  const avgSpd=elapsedSec>0?(totalDist/(elapsedSec/3600)).toFixed(1):'0';
  const sess={id:Date.now(),date:new Date().toLocaleString('fr-FR'),dist:totalDist,time:elapsedSec,avgSpeed:avgSpd,dangersCrossed:sessionDangersCrossed};
  sessions.unshift(sess);if(sessions.length>50)sessions.pop();
  save();showRecap(sess);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showRecap(s){
  document.getElementById('rc-dist').textContent=s.dist.toFixed(2)+' km';
  document.getElementById('rc-time').textContent=fmtTime(s.time);
  document.getElementById('rc-spd').textContent=s.avgSpeed+' km/h';
  document.getElementById('rc-dng').textContent=s.dangersCrossed;
  document.getElementById('ov-recap').classList.add('show');
}
function fmtTime(sec){const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;return h>0?`${h}h${String(m).padStart(2,'0')}m`:`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DANGER MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDangerModal(editing,d=null){
  document.getElementById('danger-title').textContent=editing?'âœï¸ Modifier le danger':'âš ï¸ Nouveau danger';
  if(editing&&d){document.getElementById('d-type').value=d.type;document.getElementById('d-title-in').value=d.title;document.getElementById('d-desc-in').value=d.desc||'';document.getElementById('d-radius-in').value=d.radius||25;}
  else{document.getElementById('d-type').value='âš ï¸';document.getElementById('d-title-in').value='';document.getElementById('d-desc-in').value='';document.getElementById('d-radius-in').value=25;}
  document.getElementById('ov-danger').classList.add('show');
}
function closeDangerModal(){
  document.getElementById('ov-danger').classList.remove('show');
  addMode=false;pendingPos=null;editId=null;
  document.getElementById('btn-add-danger').classList.remove('active');
  document.getElementById('add-hint').classList.remove('show');
  if(map)map.getContainer().style.cursor='';
}
function saveDanger(){
  const title=document.getElementById('d-title-in').value.trim();
  if(!title){alert('Le titre est obligatoire');return;}
  const type=document.getElementById('d-type').value,desc=document.getElementById('d-desc-in').value.trim(),radius=parseInt(document.getElementById('d-radius-in').value)||25;
  if(editId!==null){const d=dangers.find(x=>x.id===editId);if(d){d.type=type;d.title=title;d.desc=desc;d.radius=radius;refreshMarker(d);}}
  else if(pendingPos){const d={id:Date.now(),lat:pendingPos[0],lng:pendingPos[1],type,title,desc,radius};dangers.push(d);addMarker(d);}
  save();updateDangerCount();closeDangerModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMarker(d){
  if(!map)return;
  const icon=L.divIcon({html:`<div class="dmk">${d.type}</div>`,iconSize:[32,32],iconAnchor:[16,16],className:''});
  const m=L.marker([d.lat,d.lng],{icon}).addTo(map);
  m.bindPopup(makePopup(d),{maxWidth:240});
  dangerMarkers[d.id]=m;
}
function makePopup(d){return `<div class="pu-title">${d.type} ${d.title}</div><div class="pu-desc">${d.desc||''}</div><div class="pu-radius">Rayon : ${d.radius}m</div><div class="pu-actions"><button class="pu-btn pu-edit" onclick="editDanger(${d.id})">âœï¸ Modifier</button><button class="pu-btn pu-del" onclick="delDanger(${d.id})">ğŸ—‘ï¸</button></div>`;}
function refreshMarker(d){const m=dangerMarkers[d.id];if(m)m.setPopupContent(makePopup(d));}
function updateDangerCount(){document.getElementById('stat-ndanger').textContent=dangers.length;}
window.editDanger=function(id){editId=id;const d=dangers.find(x=>x.id===id);if(map)map.closePopup();openDangerModal(true,d);};
window.delDanger=function(id){if(!confirm('Supprimer ce danger ?'))return;dangers=dangers.filter(d=>d.id!==id);if(dangerMarkers[id]){map.removeLayer(dangerMarkers[id]);delete dangerMarkers[id];}save();updateDangerCount();if(map)map.closePopup();};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openHistory(){renderSessions();renderDangers();document.getElementById('ov-history').classList.add('show');}
function renderSessions(){
  const el=document.getElementById('tab-sessions');
  if(!sessions.length){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“</div>Aucune session</div>';return;}
  el.innerHTML=sessions.map(s=>`<div class="card"><div class="card-row"><div class="card-date">${s.date}</div><button class="btn-icon" onclick="delSession(${s.id})">ğŸ—‘ï¸</button></div><div class="card-stats"><div class="cstat">ğŸ›£ï¸ <strong>${s.dist.toFixed(2)}</strong> km</div><div class="cstat">â±ï¸ <strong>${fmtTime(s.time)}</strong></div><div class="cstat">ğŸ’¨ <strong>${s.avgSpeed}</strong> km/h</div></div></div>`).join('');
}
function renderDangers(){
  const el=document.getElementById('tab-dangers-list');
  if(!dangers.length){el.innerHTML='<div class="empty"><div class="empty-icon">âš ï¸</div>Aucun danger</div>';return;}
  el.innerHTML=dangers.map(d=>`<div class="danger-row"><div class="di">${d.type}</div><div class="dn"><div class="dn-title">${d.title}</div><div class="dn-coord">${d.lat.toFixed(5)}, ${d.lng.toFixed(5)} Â· r:${d.radius}m</div></div><div class="dn-actions"><button class="dna" onclick="gotoD(${d.id})">ğŸ“</button><button class="dna" onclick="delDangerList(${d.id})">ğŸ—‘ï¸</button></div></div>`).join('');
}
window.delSession=function(id){if(!confirm('Supprimer ?'))return;sessions=sessions.filter(s=>s.id!==id);save();renderSessions();};
window.delDangerList=function(id){if(!confirm('Supprimer ?'))return;dangers=dangers.filter(d=>d.id!==id);if(dangerMarkers[id]){map.removeLayer(dangerMarkers[id]);delete dangerMarkers[id];}save();updateDangerCount();renderDangers();};
window.gotoD=function(id){const d=dangers.find(x=>x.id===id);if(!d||!map)return;document.getElementById('ov-history').classList.remove('show');map.setView([d.lat,d.lng],17);setTimeout(()=>{if(dangerMarkers[id])dangerMarkers[id].openPopup();},500);};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(msg,hide=false){
  const el=document.getElementById('status-bar');
  el.textContent=msg;el.classList.remove('hidden');
  if(hide)setTimeout(()=>el.classList.add('hidden'),4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
load();
document.addEventListener('DOMContentLoaded',()=>{
  initMap();
  dangers.forEach(addMarker);
  updateDangerCount();
  // Afficher le cap calibrÃ© si dÃ©jÃ  enregistrÃ©
  if(forwardDir!==null) setStatus(`ğŸ§­ Cap avant : ${Math.round(forwardDir)}Â° (${degToCardinal(forwardDir)})`,true);
});
</script>
</body>
</html>
