<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0e1a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>TrackGuard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');

  :root {
    --bg: #060a14;
    --surface: #0d1424;
    --surface2: #131d30;
    --accent: #00d4ff;
    --accent2: #ff4757;
    --accent3: #2ed573;
    --warn: #ffa502;
    --text: #e8f4f8;
    --text2: #7a9bb5;
    --border: rgba(0,212,255,0.15);
    --glow: rgba(0,212,255,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Rajdhani', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  /* ===== MAP ===== */
  #map {
    position: absolute;
    inset: 0;
    z-index: 1;
  }

  .leaflet-tile-pane { filter: saturate(0.7) brightness(0.85) hue-rotate(5deg); }

  /* ===== HUD TOP ===== */
  #hud-top {
    position: absolute;
    top: 0; left: 0; right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px 8px;
    background: linear-gradient(to bottom, rgba(6,10,20,0.95) 60%, transparent);
  }

  .logo {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--accent);
    text-shadow: 0 0 20px var(--glow);
    text-transform: uppercase;
  }

  .logo span { color: var(--accent2); }

  #speed-display {
    font-family: 'JetBrains Mono', monospace;
    font-size: 28px;
    font-weight: 600;
    color: var(--accent);
    text-shadow: 0 0 15px var(--glow);
    line-height: 1;
  }
  #speed-display small { font-size: 11px; color: var(--text2); display: block; text-align: center; letter-spacing: 2px; }

  #btn-history {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text2);
    width: 42px; height: 42px;
    border-radius: 10px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    transition: all .2s;
  }
  #btn-history:hover { border-color: var(--accent); color: var(--accent); }

  /* ===== HUD BOTTOM ===== */
  #hud-bottom {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    z-index: 100;
    padding: 12px 16px 20px;
    background: linear-gradient(to top, rgba(6,10,20,0.97) 70%, transparent);
  }

  /* Stats bar */
  #stats-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
  }

  .stat-box {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 10px;
    text-align: center;
  }
  .stat-box .val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 20px;
    font-weight: 600;
    color: var(--accent);
    line-height: 1;
  }
  .stat-box .lbl { font-size: 10px; color: var(--text2); letter-spacing: 1.5px; margin-top: 3px; text-transform: uppercase; }

  /* Buttons row */
  #btn-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  #btn-record {
    flex: 1;
    height: 52px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all .3s;
    background: linear-gradient(135deg, #1a2a1a, #0d2a0d);
    color: var(--accent3);
    border: 1px solid var(--accent3);
    box-shadow: 0 0 15px rgba(46,213,115,0.2);
    position: relative;
    overflow: hidden;
  }
  #btn-record.recording {
    background: linear-gradient(135deg, #2a1a1a, #2a0d0d);
    color: var(--accent2);
    border-color: var(--accent2);
    box-shadow: 0 0 15px rgba(255,71,87,0.3);
    animation: pulse-record 1.5s ease-in-out infinite;
  }
  @keyframes pulse-record {
    0%,100% { box-shadow: 0 0 15px rgba(255,71,87,0.3); }
    50% { box-shadow: 0 0 30px rgba(255,71,87,0.6); }
  }

  #btn-center {
    width: 52px; height: 52px;
    border-radius: 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--accent);
    font-size: 22px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all .2s;
    flex-shrink: 0;
  }
  #btn-center:hover { border-color: var(--accent); box-shadow: 0 0 10px var(--glow); }

  #btn-add-danger {
    width: 52px; height: 52px;
    border-radius: 14px;
    background: linear-gradient(135deg, #2a1a0d, #1a0d00);
    border: 1px solid var(--warn);
    color: var(--warn);
    font-size: 22px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all .2s;
    flex-shrink: 0;
    box-shadow: 0 0 10px rgba(255,165,2,0.2);
  }
  #btn-add-danger:hover { box-shadow: 0 0 20px rgba(255,165,2,0.4); }
  #btn-add-danger.active { background: var(--warn); color: var(--bg); }

  /* ===== USER MARKER ===== */
  .user-dot {
    width: 18px; height: 18px;
    background: var(--accent);
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 0 4px rgba(0,212,255,0.3), 0 0 20px rgba(0,212,255,0.5);
    animation: ping 2s ease-in-out infinite;
  }
  @keyframes ping {
    0%,100% { box-shadow: 0 0 0 4px rgba(0,212,255,0.3), 0 0 20px rgba(0,212,255,0.5); }
    50% { box-shadow: 0 0 0 8px rgba(0,212,255,0.1), 0 0 30px rgba(0,212,255,0.3); }
  }

  /* ===== ALERT ===== */
  #alert-banner {
    position: absolute;
    top: 80px; left: 16px; right: 16px;
    z-index: 200;
    background: linear-gradient(135deg, rgba(255,71,87,0.95), rgba(180,30,45,0.95));
    border: 1px solid var(--accent2);
    border-radius: 14px;
    padding: 12px 16px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: 0 0 30px rgba(255,71,87,0.5);
    transform: translateY(-150%);
    transition: transform .4s cubic-bezier(0.34,1.56,0.64,1);
  }
  #alert-banner.show { transform: translateY(0); }
  #alert-icon { font-size: 28px; flex-shrink: 0; }
  #alert-title { font-size: 16px; font-weight: 700; letter-spacing: 1px; }
  #alert-sub { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 2px; }

  /* ===== MODAL ===== */
  .modal-overlay {
    position: fixed; inset: 0;
    z-index: 500;
    background: rgba(6,10,20,0.85);
    backdrop-filter: blur(8px);
    display: flex; align-items: flex-end; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity .3s;
  }
  .modal-overlay.show { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px 20px 0 0;
    padding: 20px;
    width: 100%; max-width: 500px;
    max-height: 85vh;
    overflow-y: auto;
    transform: translateY(100%);
    transition: transform .4s cubic-bezier(0.34,1.56,0.64,1);
  }
  .modal-overlay.show .modal { transform: translateY(0); }

  .modal-handle {
    width: 40px; height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 0 auto 16px;
  }

  .modal-title {
    font-size: 18px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase;
    color: var(--accent); margin-bottom: 16px;
  }

  .form-group { margin-bottom: 14px; }
  .form-group label { display: block; font-size: 12px; color: var(--text2); letter-spacing: 1px; margin-bottom: 6px; text-transform: uppercase; }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    padding: 10px 12px;
    outline: none;
    transition: border-color .2s;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent); }
  .form-group select option { background: var(--surface2); }
  .form-group textarea { resize: vertical; min-height: 60px; }

  .btn-primary {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent), #0099cc);
    border: none; border-radius: 12px;
    color: var(--bg);
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase;
    cursor: pointer;
    transition: all .2s;
  }
  .btn-primary:hover { filter: brightness(1.1); }

  .btn-danger {
    background: linear-gradient(135deg, var(--accent2), #cc0015);
    color: white;
  }

  .btn-secondary {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text2);
    margin-top: 8px;
  }

  /* ===== HISTORY ===== */
  .session-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: border-color .2s;
  }
  .session-card:hover { border-color: var(--accent); }
  .session-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
  .session-date { font-size: 13px; color: var(--text2); letter-spacing: 1px; }
  .session-stats { display: flex; gap: 16px; margin-top: 8px; }
  .session-stat { font-size: 13px; color: var(--text2); }
  .session-stat strong { color: var(--accent); font-family: 'JetBrains Mono', monospace; }
  .btn-del { background: none; border: none; color: var(--accent2); cursor: pointer; font-size: 18px; padding: 2px 6px; }

  /* ===== DANGER LIST ===== */
  .danger-item {
    background: var(--surface2);
    border: 1px solid rgba(255,165,2,0.2);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 8px;
    display: flex; align-items: center; gap: 10px;
  }
  .danger-item .d-icon { font-size: 22px; flex-shrink: 0; }
  .danger-item .d-info { flex: 1; }
  .danger-item .d-title { font-size: 14px; font-weight: 600; color: var(--warn); }
  .danger-item .d-coords { font-size: 11px; color: var(--text2); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
  .danger-item .d-actions { display: flex; gap: 6px; }
  .d-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text2); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all .2s; }
  .d-btn:hover { border-color: var(--accent); color: var(--accent); }
  .d-btn.del:hover { border-color: var(--accent2); color: var(--accent2); }

  /* tabs */
  .tabs { display: flex; gap: 6px; margin-bottom: 16px; }
  .tab { flex: 1; padding: 9px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text2); font-family: 'Rajdhani', sans-serif; font-size: 13px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all .2s; text-align: center; }
  .tab.active { background: rgba(0,212,255,0.1); border-color: var(--accent); color: var(--accent); }

  /* ===== RECAP ===== */
  .recap-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .recap-box { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; text-align: center; }
  .recap-box .rv { font-family: 'JetBrains Mono', monospace; font-size: 26px; font-weight: 600; color: var(--accent); }
  .recap-box .rl { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 4px; }

  /* ===== DANGER MARKER ===== */
  .danger-marker-icon { font-size: 28px; cursor: pointer; filter: drop-shadow(0 0 6px rgba(255,165,2,0.8)); }

  /* empty state */
  .empty { text-align: center; color: var(--text2); font-size: 14px; padding: 30px; }
  .empty .e-icon { font-size: 40px; margin-bottom: 10px; }

  /* adding mode indicator */
  #add-mode-hint {
    position: absolute;
    top: 80px; left: 50%; transform: translateX(-50%);
    z-index: 150;
    background: rgba(255,165,2,0.9);
    color: var(--bg);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px; font-weight: 700; letter-spacing: 1px;
    pointer-events: none;
    display: none;
  }
  #add-mode-hint.show { display: block; }

  /* accuracy indicator */
  #accuracy-bar {
    position: absolute;
    bottom: 130px; right: 16px;
    z-index: 100;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 11px;
    color: var(--text2);
    letter-spacing: 1px;
  }
  #accuracy-bar span { color: var(--accent); font-family: 'JetBrains Mono', monospace; }

  .leaflet-popup-content-wrapper {
    background: var(--surface) !important;
    border: 1px solid var(--border) !important;
    border-radius: 10px !important;
    color: var(--text) !important;
    font-family: 'Rajdhani', sans-serif !important;
  }
  .leaflet-popup-tip { background: var(--surface) !important; }
  .popup-title { font-size: 15px; font-weight: 700; color: var(--warn); }
  .popup-actions { display: flex; gap: 6px; margin-top: 8px; }
  .popup-btn { padding: 4px 10px; border-radius: 6px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-size: 13px; border: 1px solid; }
  .popup-btn.edit { border-color: var(--accent); color: var(--accent); background: transparent; }
  .popup-btn.del { border-color: var(--accent2); color: var(--accent2); background: transparent; }
</style>
</head>
<body>

<!-- MAP -->
<div id="map"></div>

<!-- HUD TOP -->
<div id="hud-top">
  <div class="logo">Track<span>Guard</span></div>
  <div id="speed-display">0<small>km/h</small></div>
  <button id="btn-history" title="Historique">üìã</button>
</div>

<!-- ACCURACY -->
<div id="accuracy-bar">GPS ¬±<span id="acc-val">--</span>m</div>

<!-- ADD MODE HINT -->
<div id="add-mode-hint">üëÜ APPUYEZ SUR LA CARTE POUR PLACER</div>

<!-- ALERT BANNER -->
<div id="alert-banner">
  <div id="alert-icon">‚ö†Ô∏è</div>
  <div>
    <div id="alert-title">Danger d√©tect√©</div>
    <div id="alert-sub">Vous approchez d'une zone de danger</div>
  </div>
</div>

<!-- HUD BOTTOM -->
<div id="hud-bottom">
  <div id="stats-bar">
    <div class="stat-box">
      <div class="val" id="stat-dist">0.00</div>
      <div class="lbl">km</div>
    </div>
    <div class="stat-box">
      <div class="val" id="stat-time">00:00</div>
      <div class="lbl">Temps</div>
    </div>
    <div class="stat-box">
      <div class="val" id="stat-dangers">0</div>
      <div class="lbl">Dangers</div>
    </div>
  </div>
  <div id="btn-row">
    <button id="btn-add-danger" title="Ajouter un danger">‚ö†Ô∏è</button>
    <button id="btn-record">‚ñ∂ D√âMARRER</button>
    <button id="btn-center" title="Centrer">‚óé</button>
  </div>
</div>

<!-- MODAL DANGER -->
<div class="modal-overlay" id="modal-danger">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="danger-modal-title">‚ö†Ô∏è Ajouter un danger</div>
    <div class="form-group">
      <label>Type de danger</label>
      <select id="d-type">
        <option value="‚ö†Ô∏è">‚ö†Ô∏è Danger g√©n√©ral</option>
        <option value="üöß">üöß Travaux</option>
        <option value="üöó">üöó Accident</option>
        <option value="üëÆ">üëÆ Contr√¥le police</option>
        <option value="ü¶å">ü¶å Animaux</option>
        <option value="üåä">üåä Inondation</option>
        <option value="üî•">üî• Feu / Fum√©e</option>
        <option value="üï≥Ô∏è">üï≥Ô∏è Nid de poule</option>
        <option value="‚ùÑÔ∏è">‚ùÑÔ∏è Verglas</option>
        <option value="üöë">üöë Urgence</option>
      </select>
    </div>
    <div class="form-group">
      <label>Titre *</label>
      <input type="text" id="d-title" placeholder="Ex: Travaux rue principale" maxlength="50">
    </div>
    <div class="form-group">
      <label>Description (optionnel)</label>
      <textarea id="d-desc" placeholder="D√©tails suppl√©mentaires..."></textarea>
    </div>
    <div class="form-group">
      <label>Rayon d'alerte (m)</label>
      <input type="number" id="d-radius" value="25" min="10" max="500">
    </div>
    <button class="btn-primary" id="btn-save-danger">üíæ ENREGISTRER</button>
    <button class="btn-primary btn-secondary" id="btn-cancel-danger">ANNULER</button>
  </div>
</div>

<!-- MODAL HISTORY -->
<div class="modal-overlay" id="modal-history">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üìã Donn√©es</div>
    <div class="tabs">
      <div class="tab active" data-tab="history">Historique</div>
      <div class="tab" data-tab="dangers">Dangers</div>
    </div>
    <div id="tab-history"></div>
    <div id="tab-dangers" style="display:none"></div>
    <button class="btn-primary btn-secondary" id="btn-close-history">FERMER</button>
  </div>
</div>

<!-- MODAL RECAP -->
<div class="modal-overlay" id="modal-recap">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üèÅ R√©cap de session</div>
    <div class="recap-grid">
      <div class="recap-box"><div class="rv" id="recap-dist">-</div><div class="rl">Distance</div></div>
      <div class="recap-box"><div class="rv" id="recap-time">-</div><div class="rl">Dur√©e</div></div>
      <div class="recap-box"><div class="rv" id="recap-speed">-</div><div class="rl">Vitesse moy.</div></div>
      <div class="recap-box"><div class="rv" id="recap-dangers">-</div><div class="rl">Dangers crois√©s</div></div>
    </div>
    <button class="btn-primary" id="btn-close-recap">‚úì FERMER</button>
  </div>
</div>

<script>
// ===== STATE =====
let map, userMarker, userPos = null, userCircle = null;
let addingDanger = false, editingDangerId = null;
let pendingDangerPos = null;
let dangers = [], sessions = [];
let recording = false, recordStart = null, recordTimer = null;
let totalDist = 0, elapsedSec = 0, lastPos = null, lastHeading = null;
let alerted = new Set(); // danger ids alerted this session
let dangerMarkers = {};
let currentSpeed = 0;

// ===== STORAGE =====
function save() {
  localStorage.setItem('tg_dangers', JSON.stringify(dangers));
  localStorage.setItem('tg_sessions', JSON.stringify(sessions));
}
function load() {
  try { dangers = JSON.parse(localStorage.getItem('tg_dangers') || '[]'); } catch(e) { dangers = []; }
  try { sessions = JSON.parse(localStorage.getItem('tg_sessions') || '[]'); } catch(e) { sessions = []; }
}

// ===== MAP INIT =====
function initMap() {
  map = L.map('map', {
    zoomControl: false,
    attributionControl: false,
    center: [46.2276, 2.2137],
    zoom: 13
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  L.control.attribution({ prefix: '¬© OSM', position: 'bottomleft' }).addTo(map);

  map.on('click', onMapClick);
}

// ===== USER MARKER =====
function getOrCreateUserMarker(latlng) {
  if (!userMarker) {
    const icon = L.divIcon({ html: '<div class="user-dot"></div>', iconSize: [18,18], iconAnchor: [9,9], className: '' });
    userMarker = L.marker(latlng, { icon, zIndexOffset: 1000 }).addTo(map);
  } else {
    userMarker.setLatLng(latlng);
  }
}

// ===== GEOLOCATION =====
let watchId = null;
function startGPS() {
  if (!navigator.geolocation) { alert('G√©olocalisation non disponible'); return; }
  watchId = navigator.geolocation.watchPosition(onPosition, onGPSError, {
    enableHighAccuracy: true, maximumAge: 1000, timeout: 10000
  });
}

let lastTimestamp = null;
function onPosition(pos) {
  const { latitude, longitude, accuracy, speed, heading } = pos.coords;
  userPos = [latitude, longitude];

  document.getElementById('acc-val').textContent = Math.round(accuracy);

  // Speed display
  const spd = speed != null ? Math.round(speed * 3.6) : 0;
  currentSpeed = spd;
  document.getElementById('speed-display').innerHTML = spd + '<small>km/h</small>';

  getOrCreateUserMarker(userPos);

  // Recording
  if (recording && lastPos) {
    const d = haversine(lastPos, userPos);
    // Only count forward movement (>0.5m and not suspicious jump >100m)
    if (d > 0.0005 && d < 0.1) {
      totalDist += d;
      document.getElementById('stat-dist').textContent = totalDist.toFixed(2);
    }
  }
  if (recording) lastPos = userPos;

  // Danger alerts
  checkDangerAlerts();

  lastTimestamp = pos.timestamp;
}

function onGPSError(err) {
  console.warn('GPS error:', err.message);
}

// ===== HAVERSINE =====
function haversine(a, b) {
  const R = 6371; // km
  const dLat = (b[0]-a[0]) * Math.PI/180;
  const dLon = (b[1]-a[1]) * Math.PI/180;
  const sin1 = Math.sin(dLat/2), sin2 = Math.sin(dLon/2);
  const c = sin1*sin1 + Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*sin2*sin2;
  return R * 2 * Math.atan2(Math.sqrt(c), Math.sqrt(1-c));
}

function distMeters(a, b) { return haversine(a, b) * 1000; }

// ===== DANGER ALERTS =====
let alertTimeout = null;
function checkDangerAlerts() {
  if (!userPos) return;
  for (const d of dangers) {
    const dist = distMeters(userPos, [d.lat, d.lng]);
    const threshold = d.radius || 25;
    if (dist <= threshold && !alerted.has(d.id)) {
      alerted.add(d.id);
      triggerAlert(d);
    }
    if (dist > threshold * 2) alerted.delete(d.id);
  }
}

function triggerAlert(danger) {
  const banner = document.getElementById('alert-banner');
  document.getElementById('alert-icon').textContent = danger.type || '‚ö†Ô∏è';
  document.getElementById('alert-title').textContent = danger.title;
  document.getElementById('alert-sub').textContent = `Dans ${danger.radius || 25}m ¬∑ ${danger.desc || 'Soyez prudent'}`;
  banner.classList.add('show');
  playBeep();
  if (alertTimeout) clearTimeout(alertTimeout);
  alertTimeout = setTimeout(() => banner.classList.remove('show'), 5000);
}

// ===== SOUND =====
let audioCtx = null;
function playBeep() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const ctx = audioCtx;
    const schedule = (freq, start, dur) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime + start);
      gain.gain.setValueAtTime(0.4, ctx.currentTime + start);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + start + dur);
      osc.start(ctx.currentTime + start);
      osc.stop(ctx.currentTime + start + dur);
    };
    schedule(880, 0, 0.15);
    schedule(1100, 0.2, 0.15);
    schedule(880, 0.4, 0.25);
  } catch(e) {}
}

// ===== MAP CLICK =====
function onMapClick(e) {
  if (!addingDanger) return;
  pendingDangerPos = [e.latlng.lat, e.latlng.lng];
  editingDangerId = null;
  openDangerModal(false);
}

// ===== ADD DANGER BUTTON =====
document.getElementById('btn-add-danger').addEventListener('click', () => {
  addingDanger = !addingDanger;
  document.getElementById('btn-add-danger').classList.toggle('active', addingDanger);
  document.getElementById('add-mode-hint').classList.toggle('show', addingDanger);
  map.getContainer().style.cursor = addingDanger ? 'crosshair' : '';
});

// ===== DANGER MODAL =====
function openDangerModal(editing, d = null) {
  const modal = document.getElementById('modal-danger');
  document.getElementById('danger-modal-title').textContent = editing ? '‚úèÔ∏è Modifier le danger' : '‚ö†Ô∏è Ajouter un danger';
  if (editing && d) {
    document.getElementById('d-type').value = d.type;
    document.getElementById('d-title').value = d.title;
    document.getElementById('d-desc').value = d.desc || '';
    document.getElementById('d-radius').value = d.radius || 25;
  } else {
    document.getElementById('d-type').value = '‚ö†Ô∏è';
    document.getElementById('d-title').value = '';
    document.getElementById('d-desc').value = '';
    document.getElementById('d-radius').value = 25;
  }
  modal.classList.add('show');
}

document.getElementById('btn-save-danger').addEventListener('click', () => {
  const title = document.getElementById('d-title').value.trim();
  if (!title) { alert('Titre obligatoire'); return; }
  const type = document.getElementById('d-type').value;
  const desc = document.getElementById('d-desc').value.trim();
  const radius = parseInt(document.getElementById('d-radius').value) || 25;

  if (editingDangerId !== null) {
    const d = dangers.find(x => x.id === editingDangerId);
    if (d) { d.type = type; d.title = title; d.desc = desc; d.radius = radius; }
    updateDangerMarker(d);
  } else if (pendingDangerPos) {
    const d = { id: Date.now(), lat: pendingDangerPos[0], lng: pendingDangerPos[1], type, title, desc, radius };
    dangers.push(d);
    addDangerMarker(d);
  }

  save();
  updateDangerCount();
  closeDangerModal();
});

document.getElementById('btn-cancel-danger').addEventListener('click', closeDangerModal);

function closeDangerModal() {
  document.getElementById('modal-danger').classList.remove('show');
  addingDanger = false;
  pendingDangerPos = null;
  editingDangerId = null;
  document.getElementById('btn-add-danger').classList.remove('active');
  document.getElementById('add-mode-hint').classList.remove('show');
  map.getContainer().style.cursor = '';
}

// ===== DANGER MARKERS =====
function addDangerMarker(d) {
  const icon = L.divIcon({ html: `<div class="danger-marker-icon">${d.type}</div>`, iconSize: [36,36], iconAnchor: [18,18], className: '' });
  const marker = L.marker([d.lat, d.lng], { icon }).addTo(map);
  marker.bindPopup(createPopup(d));
  dangerMarkers[d.id] = marker;
}

function createPopup(d) {
  return `<div class="popup-title">${d.type} ${d.title}</div>
    <div style="font-size:12px;color:var(--text2);margin-top:4px">${d.desc || ''}</div>
    <div style="font-size:11px;color:var(--text2);margin-top:4px">Rayon: ${d.radius}m</div>
    <div class="popup-actions">
      <button class="popup-btn edit" onclick="editDanger(${d.id})">‚úèÔ∏è Modifier</button>
      <button class="popup-btn del" onclick="deleteDanger(${d.id})">üóëÔ∏è Supprimer</button>
    </div>`;
}

function updateDangerMarker(d) {
  const m = dangerMarkers[d.id];
  if (m) m.setPopupContent(createPopup(d));
}

function deleteDanger(id) {
  if (!confirm('Supprimer ce danger ?')) return;
  dangers = dangers.filter(d => d.id !== id);
  if (dangerMarkers[id]) { map.removeLayer(dangerMarkers[id]); delete dangerMarkers[id]; }
  save(); updateDangerCount();
  map.closePopup();
}

function editDanger(id) {
  editingDangerId = id;
  const d = dangers.find(x => x.id === id);
  map.closePopup();
  openDangerModal(true, d);
}

window.deleteDanger = deleteDanger;
window.editDanger = editDanger;

function updateDangerCount() {
  document.getElementById('stat-dangers').textContent = dangers.length;
}

function loadDangerMarkers() {
  dangers.forEach(addDangerMarker);
  updateDangerCount();
}

// ===== RECORDING =====
document.getElementById('btn-record').addEventListener('click', toggleRecord);

function toggleRecord() {
  if (!recording) startRecord(); else stopRecord();
}

function startRecord() {
  if (!userPos) { alert('GPS non disponible, attendez le signal...'); return; }
  // Unlock audio
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  recording = true;
  recordStart = Date.now();
  totalDist = 0;
  elapsedSec = 0;
  lastPos = userPos ? [...userPos] : null;
  alerted.clear();
  document.getElementById('btn-record').textContent = '‚èπ ARR√äTER';
  document.getElementById('btn-record').classList.add('recording');
  document.getElementById('stat-dist').textContent = '0.00';
  document.getElementById('stat-time').textContent = '00:00';
  recordTimer = setInterval(updateTimer, 1000);
}

function stopRecord() {
  recording = false;
  clearInterval(recordTimer);
  document.getElementById('btn-record').textContent = '‚ñ∂ D√âMARRER';
  document.getElementById('btn-record').classList.remove('recording');

  const session = {
    id: Date.now(),
    date: new Date().toLocaleString('fr-FR'),
    dist: totalDist,
    time: elapsedSec,
    avgSpeed: elapsedSec > 0 ? (totalDist / (elapsedSec / 3600)).toFixed(1) : 0,
    dangersCount: dangers.length
  };
  sessions.unshift(session);
  if (sessions.length > 50) sessions.pop();
  save();
  showRecap(session);
}

function updateTimer() {
  elapsedSec++;
  const m = String(Math.floor(elapsedSec/60)).padStart(2,'0');
  const s = String(elapsedSec%60).padStart(2,'0');
  document.getElementById('stat-time').textContent = `${m}:${s}`;
}

// ===== RECAP =====
function showRecap(s) {
  document.getElementById('recap-dist').textContent = s.dist.toFixed(2) + ' km';
  document.getElementById('recap-time').textContent = formatTime(s.time);
  document.getElementById('recap-speed').textContent = s.avgSpeed + ' km/h';
  document.getElementById('recap-dangers').textContent = s.dangersCount;
  document.getElementById('modal-recap').classList.add('show');
}

document.getElementById('btn-close-recap').addEventListener('click', () => {
  document.getElementById('modal-recap').classList.remove('show');
});

function formatTime(sec) {
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  if (h > 0) return `${h}h${String(m).padStart(2,'0')}`;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ===== HISTORY MODAL =====
document.getElementById('btn-history').addEventListener('click', openHistory);
document.getElementById('btn-close-history').addEventListener('click', () => {
  document.getElementById('modal-history').classList.remove('show');
});

function openHistory() {
  renderHistory();
  renderDangersList();
  document.getElementById('modal-history').classList.add('show');
}

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    const which = tab.dataset.tab;
    document.getElementById('tab-history').style.display = which === 'history' ? 'block' : 'none';
    document.getElementById('tab-dangers').style.display = which === 'dangers' ? 'block' : 'none';
  });
});

function renderHistory() {
  const el = document.getElementById('tab-history');
  if (sessions.length === 0) {
    el.innerHTML = '<div class="empty"><div class="e-icon">üìç</div>Aucune session enregistr√©e</div>';
    return;
  }
  el.innerHTML = sessions.map(s => `
    <div class="session-card">
      <div class="session-card-header">
        <div class="session-date">${s.date}</div>
        <button class="btn-del" onclick="deleteSession(${s.id})">üóëÔ∏è</button>
      </div>
      <div class="session-stats">
        <div class="session-stat">üõ£Ô∏è <strong>${s.dist.toFixed(2)}</strong> km</div>
        <div class="session-stat">‚è±Ô∏è <strong>${formatTime(s.time)}</strong></div>
        <div class="session-stat">üí® <strong>${s.avgSpeed}</strong> km/h moy</div>
      </div>
    </div>
  `).join('');
}

function renderDangersList() {
  const el = document.getElementById('tab-dangers');
  if (dangers.length === 0) {
    el.innerHTML = '<div class="empty"><div class="e-icon">‚ö†Ô∏è</div>Aucun danger enregistr√©</div>';
    return;
  }
  el.innerHTML = dangers.map(d => `
    <div class="danger-item">
      <div class="d-icon">${d.type}</div>
      <div class="d-info">
        <div class="d-title">${d.title}</div>
        <div class="d-coords">${d.lat.toFixed(5)}, ${d.lng.toFixed(5)} ¬∑ r:${d.radius}m</div>
      </div>
      <div class="d-actions">
        <button class="d-btn" onclick="gotoAndEdit(${d.id})">‚úèÔ∏è</button>
        <button class="d-btn del" onclick="deleteDangerFromList(${d.id})">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}

function deleteSession(id) {
  if (!confirm('Supprimer cette session ?')) return;
  sessions = sessions.filter(s => s.id !== id);
  save(); renderHistory();
}

function deleteDangerFromList(id) {
  if (!confirm('Supprimer ce danger ?')) return;
  dangers = dangers.filter(d => d.id !== id);
  if (dangerMarkers[id]) { map.removeLayer(dangerMarkers[id]); delete dangerMarkers[id]; }
  save(); updateDangerCount(); renderDangersList();
}

function gotoAndEdit(id) {
  const d = dangers.find(x => x.id === id);
  if (!d) return;
  document.getElementById('modal-history').classList.remove('show');
  map.setView([d.lat, d.lng], 17);
  setTimeout(() => {
    if (dangerMarkers[id]) dangerMarkers[id].openPopup();
  }, 400);
}

window.deleteSession = deleteSession;
window.deleteDangerFromList = deleteDangerFromList;
window.gotoAndEdit = gotoAndEdit;

// ===== CENTER =====
document.getElementById('btn-center').addEventListener('click', () => {
  if (userPos) map.setView(userPos, 17);
});

// ===== INIT =====
load();
initMap();
loadDangerMarkers();
startGPS();

// Auto-center on first fix
let firstFix = true;
const origOnPos = onPosition;
navigator.geolocation.getCurrentPosition(pos => {
  const latlng = [pos.coords.latitude, pos.coords.longitude];
  map.setView(latlng, 16);
  getOrCreateUserMarker(latlng);
  userPos = latlng;
  checkDangerAlerts();
}, () => {}, { enableHighAccuracy: true });
</script>
</body>
</html>
